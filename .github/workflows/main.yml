name: Build and push
on: [push]

jobs:
  
  tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [12.x, 14.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
      
  create_template_file:
    runs-on: ubuntu-latest
    
    steps:
    - name: stage 1 (run checkout action)
      uses: actions/checkout@v2
    
    - name: create cfg file
      #uses: 
      env:
        SOME_VARIABLE_1: value_1
        SOME_VARIABLE_2: value_2
        API_TOKEN_GITHUB: ${{secrets.API_TOKEN_GITHUB_PUSH}}
      run: |
        cat template.cfg | envsubst > whatever.cfg
        cat whatever.cfg
    - name: commit and push
      run: |
        git config --global user.name 'twig-trainer'
        git config --global user.email 'twig.trainer-05@icloud.com'
        git remote set-url origin https://twig-trainer:${{ secrets.API_TOKEN_GITHUB_PUSH }}@github.com/twig-trainer/argocd-dev
        git add .
        git commit -am "Automated Push cfg file"
        git push

  build_and_push:
    needs: tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - name: stage 1 (run checkout action)
      env:
        DOCKER_USER: ${{secrets.DOCKER_USER}}
        DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
      run: |
        docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    - name: Set tag value
      id: set_tag
      run: |
        echo "TAG2=$(date +%s)" >> $GITHUB_ENV
    - name: stage 2 (build the docker image)
      run: |
        docker build . --file Dockerfile --tag ${{secrets.DOCKER_USER}}/nflx-dev:build_${{github.run_number}}
    - name: stage 3 ( push to registry:)
      run: |
        docker push ${{secrets.DOCKER_USER}}/nflx-dev:build_${{github.run_number}}
